<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Librer√≠a - Completa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* FONDO OSCURO */
        body { background-color: #121214; color: #ffffff; font-family: 'Inter', sans-serif; }

        /* BUSCADOR */
        .search-container { background-color: #eaddff; border-radius: 16px; }

        /* TABS (BOTONES CATEGOR√çAS) */
        .tab-btn { border-radius: 9999px; padding: 8px 20px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; cursor: pointer; }
        .tab-active { background-color: #1d9bf0; color: white; box-shadow: 0 4px 15px rgba(29, 155, 240, 0.4); }
        .tab-inactive { background-color: #202024; color: #71717a; border: 1px solid #3f3f46; }
        .tab-inactive:hover { background-color: #27272a; color: white; }

        /* TARJETAS DE LIBROS */
        .book-card {
            background-color: white;
            color: #1f2937;
            border-radius: 20px;
            overflow: hidden;
            transition: transform 0.2s;
            min-width: 180px;
            max-width: 180px;
            scroll-snap-align: start;
        }
        .book-card:hover { transform: translateY(-5px); }

        /* OCULTAR SCROLL */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* FLECHAS DE NAVEGACI√ìN */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 40px;
            height: 40px;
            background-color: #e65505;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 20;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            transition: background 0.3s, transform 0.2s;
            border: 2px solid #121214;
        }
        .nav-arrow:hover { background-color: #ff6b1a; transform: translateY(-50%) scale(1.1); }
        .nav-left { left: -15px; }
        .nav-right { right: -15px; }

        /* MODAL */
        .btn-orange { background-color: #e65505; color: white; }
        .btn-outline-orange { border: 1px solid #e65505; color: #e65505; }
    </style>
</head>
<body class="min-h-screen pb-20 overflow-x-hidden">

    <header class="pt-6 pb-2 px-4 container mx-auto max-w-6xl">
        <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-xl">üë§</div>
            <div>
                <h1 class="font-bold text-lg">Hola, Lector</h1>
                <p class="text-xs text-gray-400">Tu biblioteca personal</p>
            </div>
            <button onclick="logout()" class="ml-auto text-gray-400 hover:text-white"><i class="fas fa-sign-out-alt"></i></button>
        </div>

        <div class="search-container flex items-center px-4 py-3 shadow-sm mx-auto w-full relative">
            <i class="fas fa-search text-gray-500 text-lg"></i>
            <input type="text" id="searchInput" class="bg-transparent border-none outline-none text-gray-800 placeholder-gray-500 ml-3 w-full font-medium" placeholder="Buscar en la librer√≠a...">
        </div>
    </header>

    <nav class="container mx-auto px-4 max-w-6xl mt-4">
        <div class="flex gap-3 overflow-x-auto pb-2 hide-scroll">
            <button onclick="switchTab('Todos')" id="tab-Todos" class="tab-btn tab-active whitespace-nowrap">Todo</button>
            <button onclick="switchTab('Ficci√≥n')" id="tab-Ficci√≥n" class="tab-btn tab-inactive whitespace-nowrap">Ficci√≥n</button>
            <button onclick="switchTab('No Ficci√≥n')" id="tab-No Ficci√≥n" class="tab-btn tab-inactive whitespace-nowrap">No Ficci√≥n</button>
            <button onclick="switchTab('C√≥mic')" id="tab-C√≥mic" class="tab-btn tab-inactive whitespace-nowrap">C√≥mic</button>
        </div>
    </nav>

    <div class="container mx-auto px-4 max-w-6xl mt-6">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-[24px] p-6 flex items-center justify-between relative overflow-hidden shadow-lg shadow-blue-900/50">
            <div class="z-10">
                <h2 class="text-xl font-bold text-white mb-1">Escanear Libro</h2>
                <p class="text-blue-100 text-xs mb-3">A√±ade r√°pido con la c√°mara</p>
                <a href="scan.html" class="bg-white text-blue-600 text-xs font-bold px-4 py-2 rounded-full shadow-md hover:bg-gray-100 transition">
                    <i class="fas fa-barcode mr-1"></i> C√°mara
                </a>
            </div>
            <i class="fas fa-book text-8xl text-white opacity-10 absolute -right-4 -bottom-4 rotate-12"></i>
        </div>
    </div>

    <main class="container mx-auto px-4 max-w-6xl mt-10 space-y-12">
        
        <section>
            <h3 id="main-section-title" class="text-xl font-bold mb-4 pl-1 flex items-center gap-2">
                <span class="bg-purple-500 w-1 h-6 rounded-full inline-block"></span>
                Explorar: <span id="current-cat-name" class="text-purple-300 ml-1">Todo</span>
            </h3>
            
            <div class="relative group">
                <button onclick="scrollGrid('left', 'carrusel-main')" class="nav-arrow nav-left hidden md:flex"><i class="fas fa-chevron-left"></i></button>
                
                <div id="carrusel-main" class="flex gap-4 overflow-x-auto hide-scroll scroll-smooth pb-4 px-1 snap-x">
                    </div>
                
                <button onclick="scrollGrid('right', 'carrusel-main')" class="nav-arrow nav-right hidden md:flex"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>

        <section>
            <h3 class="text-xl font-bold mb-4 pl-1 flex items-center gap-2">
                <span class="bg-blue-500 w-1 h-6 rounded-full inline-block"></span>
                Continuar Leyendo
            </h3>
            
            <div class="relative group">
                <button onclick="scrollGrid('left', 'carrusel-reading')" class="nav-arrow nav-left hidden md:flex"><i class="fas fa-chevron-left"></i></button>
                <div id="carrusel-reading" class="flex gap-4 overflow-x-auto hide-scroll scroll-smooth pb-4 px-1 snap-x">
                    </div>
                <button onclick="scrollGrid('right', 'carrusel-reading')" class="nav-arrow nav-right hidden md:flex"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>


        <section>
            <h3 class="text-xl font-bold mb-4 pl-1 flex items-center gap-2">
                <span class="bg-orange-500 w-1 h-6 rounded-full inline-block"></span>
                Novedades
            </h3>
            
            <div class="relative group">
                <button onclick="scrollGrid('left', 'carrusel-news')" class="nav-arrow nav-left hidden md:flex"><i class="fas fa-chevron-left"></i></button>
                <div id="carrusel-news" class="flex gap-4 overflow-x-auto hide-scroll scroll-smooth pb-4 px-1 snap-x">
                    </div>
                <button onclick="scrollGrid('right', 'carrusel-news')" class="nav-arrow nav-right hidden md:flex"><i class="fas fa-chevron-right"></i></button>
            </div>
        </section>

    </main>

    <div id="product-modal" class="fixed inset-0 z-50 hidden bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-4xl rounded-xl shadow-2xl relative text-gray-800 animate-[fadeIn_0.3s_ease-out]">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-900 z-10 text-2xl"><i class="fas fa-times"></i></button>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-0">
                <div class="p-6 bg-gray-50 flex items-center justify-center rounded-l-xl">
                    <img id="modal-img" src="" class="shadow-xl max-w-[160px] rounded transform hover:scale-105 transition duration-500">
                </div>
                <div class="p-6 md:p-8 flex flex-col">
                    <span id="modal-cat" class="text-xs font-bold text-orange-600 uppercase mb-1">Categor√≠a</span>
                    <h2 id="modal-title" class="text-2xl font-bold text-gray-900 mb-1">T√≠tulo</h2>
                    <p id="modal-author" class="text-gray-600 mb-4 font-medium">Autor</p>
                    <p id="modal-desc" class="text-sm text-gray-600 mb-6 flex-1 line-clamp-4">Descripci√≥n...</p>
                    <div class="mt-auto border-t border-gray-100 pt-4">
                        <span id="modal-price" class="text-3xl font-bold text-orange-600 block mb-3">Precio</span>
                        <div class="flex gap-3">
                            <button class="flex-1 btn-orange py-3 rounded-lg font-bold shadow">A√±adir</button>
                            <button class="flex-1 btn-outline-orange bg-white py-3 rounded-lg font-bold">Reservar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 1. CARGAR PERFIL DE USUARIO ===
        async function loadUserProfile() {
            try {
                // Hacemos la petici√≥n a la API de usuario
                const response = await fetch('/api/user', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include' 
                });

                if (!response.ok) {
                    throw new Error('No autorizado');
                }

                const userData = await response.json();

                // Actualizamos el nombre en el saludo
                const greetingElement = document.querySelector('h1.font-bold'); 
                if (greetingElement) {
                    greetingElement.innerText = `Hola, ${userData.name}`; 
                }

                // Cargamos estad√≠sticas (si existen en el HTML)
                loadDashboardStats(); 

            } catch (error) {
                console.error("Error cargando perfil:", error);
                // Si falla (sesi√≥n expirada), redirigir al login
                // window.location.href = 'index.html'; // Descomenta esta l√≠nea cuando tu login est√© listo
            }
        }

        // === 2. CARGAR ESTAD√çSTICAS (La funci√≥n que faltaba) ===
        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/dashboard-stats', {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' },
                    credentials: 'include'
                });

                if (!response.ok) return; // Si falla silenciosamente, no pasa nada

                const stats = await response.json();
                
                // Solo actualizamos si los elementos existen en el HTML
                if(document.getElementById('count-books')) 
                    document.getElementById('count-books').innerText = stats.books_count;
                    
                if(document.getElementById('count-authors')) 
                    document.getElementById('count-authors').innerText = stats.authors_count;
                    
                if(document.getElementById('count-reading')) 
                    document.getElementById('count-reading').innerText = stats.reading_now;
                    
                if(document.getElementById('count-categories')) 
                    document.getElementById('count-categories').innerText = stats.categories_count;

            } catch (error) {
                console.log("No se pudieron cargar stats (¬øUsuario no logueado?)");
            }
        }

        // Ejecutar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', loadUserProfile);

        // === DATOS DE EJEMPLO PARA VISUALIZACI√ìN ===
        const mainLibraryData = [
            { id: 1, title: "Dune", author: "Frank Herbert", price: "24,90‚Ç¨", img: "https://covers.openlibrary.org/b/id/12697887-L.jpg", cat: "Ficci√≥n" },
            { id: 2, title: "Sapiens", author: "Yuval N. Harari", price: "22,90‚Ç¨", img: "https://covers.openlibrary.org/b/id/8393663-L.jpg", cat: "No Ficci√≥n" },
            { id: 3, title: "Watchmen", author: "Alan Moore", price: "35,00‚Ç¨", img: "https://covers.openlibrary.org/b/id/12555620-L.jpg", cat: "C√≥mic" },
            { id: 4, title: "1984", author: "George Orwell", price: "9,95‚Ç¨", img: "https://covers.openlibrary.org/b/id/12632200-L.jpg", cat: "Ficci√≥n" },
            { id: 5, title: "Steve Jobs", author: "Walter Isaacson", price: "18,50‚Ç¨", img: "https://covers.openlibrary.org/b/id/7342523-L.jpg", cat: "No Ficci√≥n" },
            { id: 6, title: "Maus", author: "Art Spiegelman", price: "21,00‚Ç¨", img: "https://covers.openlibrary.org/b/id/10582907-L.jpg", cat: "C√≥mic" },
            { id: 7, title: "El Quijote", author: "Cervantes", price: "15,00‚Ç¨", img: "https://covers.openlibrary.org/b/id/10565012-L.jpg", cat: "Ficci√≥n" },
            { id: 8, title: "Cosmos", author: "Carl Sagan", price: "20,00‚Ç¨", img: "https://covers.openlibrary.org/b/id/12628464-L.jpg", cat: "No Ficci√≥n" }
        ];

        const readingData = [
            { id: 101, title: "Negra nit", author: "Chris Offutt", price: "21,50‚Ç¨", img: "https://covers.openlibrary.org/b/id/8259449-L.jpg", cat: "Novela Negra" },
            { id: 102, title: "Clean Code", author: "Robert C. Martin", price: "35,00‚Ç¨", img: "https://covers.openlibrary.org/b/id/12555620-L.jpg", cat: "Tech" },
            { id: 103, title: "Dune Messiah", author: "Frank Herbert", price: "19,00‚Ç¨", img: "https://covers.openlibrary.org/b/id/14553229-L.jpg", cat: "Ficci√≥n" }
        ];

        const newsData = [
            { id: 201, title: "Todos los cuentos", author: "Clarice Lispector", price: "24,50‚Ç¨", img: "https://covers.openlibrary.org/b/id/10603763-L.jpg", cat: "Cuentos" },
            { id: 202, title: "La prueba", author: "Eliza Barry", price: "19,90‚Ç¨", img: "https://covers.openlibrary.org/b/id/12547191-L.jpg", cat: "Novedad" },
            { id: 203, title: "Hermanas raras", author: "Bodine Drake", price: "18,00‚Ç¨", img: "https://covers.openlibrary.org/b/id/12658932-L.jpg", cat: "Terror" },
            { id: 204, title: "Detectives", author: "Mar Benegas", price: "12,95‚Ç¨", img: "https://covers.openlibrary.org/b/id/12826015-L.jpg", cat: "Infantil" }
        ];

        // RENDERIZAR CUALQUIER CARRUSEL
        function renderCarrusel(containerId, data) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            data.forEach(book => {
                const jsonBook = JSON.stringify(book).replace(/"/g, "&quot;");
                container.innerHTML += `
                    <div onclick="openModal(this)" data-book="${jsonBook}" class="book-card cursor-pointer group flex flex-col flex-shrink-0 relative snap-start">
                        <div class="h-44 overflow-hidden relative bg-gray-200">
                            <img src="${book.img}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                            <div class="absolute bottom-1 left-1 bg-black/70 text-white text-[9px] px-1.5 py-0.5 rounded backdrop-blur-sm">
                                ${book.cat}
                            </div>
                        </div>
                        <div class="p-3 flex flex-col flex-1">
                            <h3 class="font-bold text-sm text-gray-900 leading-tight mb-1 line-clamp-1">${book.title}</h3>
                            <p class="text-xs text-gray-500 mb-2 truncate">${book.author}</p>
                            <div class="mt-auto flex justify-between items-center border-t border-gray-100 pt-2">
                                <span class="font-bold text-orange-600 text-sm">${book.price}</span>
                                <i class="fas fa-plus-circle text-gray-300 hover:text-orange-500 transition"></i>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // CONTROL DE TABS (Solo afecta a la primera fila)
        function switchTab(catName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });
            document.getElementById(`tab-${catName}`).classList.remove('tab-inactive');
            document.getElementById(`tab-${catName}`).classList.add('tab-active');
            
            document.getElementById('current-cat-name').textContent = catName;

            // Filtro
            const filteredData = catName === 'Todos' ? mainLibraryData : mainLibraryData.filter(b => b.cat === catName);
            renderCarrusel('carrusel-main', filteredData);
        }

        // SCROLL
        function scrollGrid(direction, containerId) {
            const container = document.getElementById(containerId);
            direction === 'left' ? container.scrollLeft -= 300 : container.scrollLeft += 300;
        }

        // MODAL
        function openModal(element) {
            const bookData = JSON.parse(element.getAttribute('data-book'));
            document.getElementById('modal-img').src = bookData.img;
            document.getElementById('modal-title').textContent = bookData.title;
            document.getElementById('modal-author').textContent = bookData.author;
            document.getElementById('modal-price').textContent = bookData.price;
            document.getElementById('modal-cat').textContent = bookData.cat;
            document.getElementById('modal-desc').textContent = `Sinopsis detallada de ${bookData.title}...`;
            document.getElementById('product-modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('product-modal').classList.add('hidden'); }
        document.getElementById('product-modal').addEventListener('click', function(e) { if (e.target === this) closeModal(); });
        function logout() { window.location.href = 'index.html'; }

        // INICIALIZACI√ìN
        switchTab('Todos'); 
        renderCarrusel('carrusel-reading', readingData); 
        renderCarrusel('carrusel-news', newsData); 

    </script>
</body>
</html>