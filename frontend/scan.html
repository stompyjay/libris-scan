<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escanear Libros - Biblioteca</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800">

    <nav class="bg-blue-600 p-4 text-white shadow-md mb-8">
        <div class="container mx-auto flex justify-between items-center">
            <a href="dashboard.html" class="font-bold hover:underline">‚¨Ö Volver al Dashboard</a>
            <h1 class="text-xl font-bold">üîç Buscador Inteligente</h1>
            <div></div> 
        </div>
    </nav>

    <div class="container mx-auto px-4 max-w-5xl">
        
        <div class="bg-white p-6 rounded-lg shadow-md mb-8 text-center">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Encuentra tu pr√≥ximo libro</h2>
            <div class="flex gap-2 justify-center">
                <input type="text" id="search-query" 
                       class="w-full max-w-lg p-3 border rounded-lg shadow-inner focus:outline-none focus:ring-2 focus:ring-blue-500"
                       placeholder="Escribe el t√≠tulo (ej: Harry Potter, Dune...)"
                       onkeypress="if(event.key === 'Enter') searchBooks()">
                
                <button onclick="searchBooks()" 
                        class="bg-blue-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-700 transition shadow">
                    Buscar
                </button>
            </div>
            <p class="text-xs text-gray-500 mt-2">Tecnolog√≠a powered by OpenLibrary API</p>
        </div>

        <div id="results-grid" class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
            </div>

        <div id="loading" class="hidden text-center py-10">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
            <p class="mt-4 text-gray-600">Consultando librer√≠as del mundo...</p>
        </div>

    </div>

    <script>
        // CONFIGURACI√ìN
        const API_URL = '/api'; // Ajusta si tu prefijo cambia
        let currentResults = [];

        // Helper para Token CSRF
        function getCsrfToken() {
            const match = document.cookie.match(/XSRF-TOKEN=([^;]+)/);
            return match ? decodeURIComponent(match[1]) : null;
        }

        // FUNCI√ìN 1: Buscar en la API (GET)
        async function searchBooks() {
            const query = document.getElementById('search-query').value;
            const resultsGrid = document.getElementById('results-grid');
            const loading = document.getElementById('loading');

            if (!query) return alert("Escribe algo primero");

            // UI: Mostrar carga
            loading.classList.remove('hidden');
            resultsGrid.innerHTML = '';

            try {
                // GET a tu backend Laravel. Las cookies de sesi√≥n van autom√°ticas.
                const response = await fetch(`${API_URL}/scan?query=${encodeURIComponent(query)}`);

                if (response.status === 401 || response.status === 419) {
                    window.location.href = 'login.html';
                    return;
                }

                const books = await response.json();
                currentResults = books; // Guardamos para usar al clickar guardar

                loading.classList.add('hidden');

                if (!books || books.length === 0) {
                    resultsGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">No encontramos nada. Prueba con otro nombre.</p>`;
                    return;
                }

                // Generar HTML
                books.forEach((book, index) => {
                    // L√≥gica para la imagen
                    const coverUrl = book.cover_id 
                        ? `https://covers.openlibrary.org/b/id/${book.cover_id}-M.jpg`
                        : (book.cover_url || 'https://via.placeholder.com/150x220?text=Sin+Portada');

                    // Guardamos la URL calculada en el objeto para enviarla luego al backend si hace falta
                    currentResults[index].final_cover_url = coverUrl;

                    const card = `
                        <div class="bg-white rounded-lg shadow hover:shadow-xl transition overflow-hidden flex flex-col h-full border border-gray-100">
                            <div class="h-48 bg-gray-200 flex justify-center items-center overflow-hidden">
                                <img src="${coverUrl}" alt="Portada" class="h-full object-cover w-full">
                            </div>
                            <div class="p-4 flex-1 flex flex-col">
                                <h3 class="font-bold text-lg text-gray-800 leading-tight mb-1 line-clamp-2">${book.title}</h3>
                                <p class="text-sm text-gray-600 mb-2 line-clamp-1">Autor: ${book.author}</p>
                                <p class="text-xs text-gray-400 mb-4">A√±o: ${book.year || 'N/D'} | Cat: ${book.suggested_category}</p>
                                
                                <button id="btn-${index}" onclick="saveBook(${index})" 
                                        class="mt-auto w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 transition font-semibold shadow-sm">
                                    + A√±adir a mi lista
                                </button>
                            </div>
                        </div>
                    `;
                    resultsGrid.innerHTML += card;
                });

            } catch (error) {
                console.error(error);
                loading.classList.add('hidden');
                alert("Error conectando con el servidor");
            }
        }

        // FUNCI√ìN 2: Guardar un libro (POST)
        async function saveBook(index) {
            const bookToSave = currentResults[index];
            const btn = document.getElementById(`btn-${index}`);

            // UI Feedback
            const originalText = btn.textContent;
            btn.textContent = "Guardando...";
            btn.disabled = true;
            btn.classList.add('opacity-75');

            try {
                // Enviamos POST a /api/scan (o donde hayas configurado el store)
                const response = await fetch(`${API_URL}/scan`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-XSRF-TOKEN': getCsrfToken() // <--- IMPORTANTE
                    },
                    body: JSON.stringify({
                        title: bookToSave.title,
                        author: bookToSave.author, // Tu backend procesar√° esto y buscar√°/crear√° el autor
                        suggested_category: bookToSave.suggested_category,
                        year: bookToSave.year,
                        cover_url: bookToSave.final_cover_url // Enviamos la imagen tambi√©n
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    btn.textContent = "‚úî Guardado";
                    btn.className = "mt-auto w-full bg-gray-500 text-white py-2 rounded cursor-default";
                    // Confeti o alerta opcional
                } else {
                    throw new Error(data.message || "Error al guardar");
                }

            } catch (error) {
                console.error(error);
                btn.textContent = "Error - Reintentar";
                btn.disabled = false;
                btn.classList.remove('opacity-75');
                alert(error.message);
            }
        }
    </script>
</body>
</html>